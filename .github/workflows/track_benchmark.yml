name: Track Benchmark

on:
    push:
      branches: main
    pull_request:
      paths-ignore: ["docs/**", "**.md"]
      types: [opened, reopened, synchronize, labeled]

jobs:
    benchmark_with_bencher:
      name: Continuous Benchmarking with Bencher
      runs-on: ubuntu-latest
      env:
        BENCHER_PROJECT: tailcall
        BENCHER_TESTBED: ubuntu-latest
        BENCHER_ADAPTER: json
        PR_BENCHMARK_RESULTS: benches/benchmarks.json 
        BASE_BENCHMARK_RESULTS: benches/main_benchmarks.json
        UPPER_BOUNDARY: 0.90
      steps:
        - name: Check out code
          uses: actions/checkout@v4
          with:
            ref: ${{ github.event.pull_request.head.sha }}

        - uses: bencherdev/bencher@main
            
        - name: Track base Benchmarks
          run: |

            export FEATURE_BRANCH=feature-branch-$(git rev-parse --short HEAD)
            export BENCHER_API_TOKEN=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJhcGlfa2V5IiwiZXhwIjoxNzIwMDYyMTI4LCJpYXQiOjE3MTAwNjIxMjgsImlzcyI6ImJlbmNoZXIuZGV2Iiwic3ViIjoiZGFicmFsYWxhbmtyaXR
            AZ21haWwuY29tIiwib3JnIjpudWxsfQ.0QUtYqWgPtyYV8d6SsK2m4hNoa88r6aSI6Ojupatd3s
            
            bencher run \
            --token $BENCHER_API_TOKEN \
            --file "$BASE_BENCHMARK_RESULTS"
        - name: Create PR threshold
          run: |
            bencher threshold create \
            --project "$BENCHER_PROJECT" \
            --branch '${{ env.PR_HEAD }}' \
            --testbed "$BENCHER_TESTBED" \
            --measure latency \
            --test t \
            --upper-boundary ${{ env.UPPER_BOUNDARY }} \
            --token yJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJhcGlfa2V5IiwiZXhwIjo2MDA1MDIxMDgzLCJpYXQiOjE3MTAwNTM3ODgsImlzcyI6ImJlbmNoZXIuZGV2Iiwic3ViIjoiZGFicmFsYWxhbmtyaXRAZ21haWwuY29tIiwib3JnIjpudWxsfQ.NYbyDLA7aJN6535_YUjIPN1TsMbZc86qxhGKFgkXVkc \
        - name: Track PR Benchmarks
          run: |
            bencher run \
            --branch '${{ env.PR_HEAD }}' \
            --token yJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJhcGlfa2V5IiwiZXhwIjo2MDA1MDIxMDgzLCJpYXQiOjE3MTAwNTM3ODgsImlzcyI6ImJlbmNoZXIuZGV2Iiwic3ViIjoiZGFicmFsYWxhbmtyaXRAZ21haWwuY29tIiwib3JnIjpudWxsfQ.NYbyDLA7aJN6535_YUjIPN1TsMbZc86qxhGKFgkXVkc \
            --ci-id '${{ env.PR_ID }}' \
            --ci-number '${{ env.PR_NUMBER }}' \
            --github-actions "${{ secrets.GITHUB_TOKEN }}" \
            --err \
            --file "$PR_BENCHMARK_RESULTS"
