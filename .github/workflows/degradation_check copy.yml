name: Benchmarks and build time

on:
  pull_request:
    branches: [main]
    types: [opened, reopened, synchronize]

jobs:
  runBenchmarks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Dependencies
        run: cargo install boa-dev/criterion-compare-action@3.2.4

      - name: Run benchmarks and comment on PR
        if: github.event_name == 'pull_request'
        run: |
          # Run benchmarks
          npx boa-dev/criterion-compare-action@3.2.4 json_like_bench --defaultFeatures=false --branchName=${{ github.base_ref }} --token=${{ secrets.GITHUB_TOKEN }}
          npx boa-dev/criterion-compare-action@3.2.4 impl_path_string_for_evaluation_context --defaultFeatures=false --branchName=${{ github.base_ref }} --token=${{ secrets.GITHUB_TOKEN }}
          npx boa-dev/criterion-compare-action@3.2.4 data_loader_bench --defaultFeatures=false --branchName=${{ github.base_ref }} --token=${{ secrets.GITHUB_TOKEN }}
          npx boa-dev/criterion-compare-action@3.2.4 request_template_bench --defaultFeatures=false --branchName=${{ github.base_ref }} --token=${{ secrets.GITHUB_TOKEN }}

          # Comment on the pull request
          output=$(/home/runner/.cargo/bin/critcmp base changes)
          echo "$output"
          awk 'NR > 2 {
              group=$1
              base=$7
              changes=$3

              gsub(/[^\-0-9\.]/, "", changes)
              gsub(/[^\-0-9\.]/, "", base)

              if (changes != "" && base != "") {
                  diff = changes - base
                  percentage = (diff / base) * 100

                  if (percentage > 10) {
                      printf "Percentage change for %s exceeds 10%%: %.2f%%\n", group, percentage
                      exit 1
                  }
              }
          }' <<< "$output" | \
          if [[ $? -eq 0 ]]; then
              COMMENT="Benchmarks Passed! :white_check_mark:"
          else
              COMMENT="Benchmarks Failed! :x:"
          fi
          echo "$COMMENT"
          echo "::set-output name=COMMENT::$COMMENT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        run: |
          COMMENT="${{ needs.runBenchmarks.outputs.COMMENT }}"
          echo "Comment: $COMMENT"
          echo "$COMMENT" | gh pr comment ${{ github.event.number }} --body -
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
